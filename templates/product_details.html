{% extends "base.html" %}
{% block content %}
<div class="container">
  <hgroup>
    <h1 id="pd-title">Product Details</h1>
    <h2 id="pd-subtitle"></h2>
  </hgroup>

  <article class="controls-grid">
    <div>
      <label>Period start</label>
      <input type="date" id="pd-start">
    </div>
    <div>
      <label>Period end</label>
      <input type="date" id="pd-end">
    </div>
    <div>
      <label>Store</label>
      <select id="pd-store"><option value="">All Stores</option></select>
    </div>
    <div class="grid" style="gap: .5rem; align-items: end;">
      <button id="pd-apply" class="secondary">Apply</button>
      <button id="pd-7" class="outline">7d</button>
      <button id="pd-30" class="outline">30d</button>
      <button id="pd-90" class="outline">90d</button>
    </div>
  </article>

  <article class="grid">
    <div class="card">
      <header><strong>Snapshot</strong></header>
      <div id="pd-snapshot" class="grid">
        <!-- filled by JS -->
      </div>
    </div>
    <div class="card">
      <header><strong>Sales Velocity</strong></header>
      <div id="pd-velocity" class="grid">
        <!-- filled by JS -->
      </div>
    </div>
  </article>

  <article class="card">
    <header><strong>Sales by Day</strong></header>
    <canvas id="pd-sales-canvas" height="220"></canvas>
  </article>

  <article class="grid">
    <div class="card">
      <header><strong>Stock Movements (by day)</strong></header>
      <div class="overflow-auto" style="max-height:300px">
        <table id="pd-sm-table"><thead><tr><th>Date</th><th>Change</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="card">
      <header><strong>Committed Orders</strong></header>
      <div class="overflow-auto" style="max-height:300px">
        <table id="pd-committed"><thead><tr><th>Date</th><th>Order</th><th>Qty</th><th>Status</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </article>

  <article class="card">
    <header><strong>Recent Orders (last 200)</strong></header>
    <div class="overflow-auto" style="max-height:360px">
      <table id="pd-orders"><thead><tr><th>Date</th><th>Order</th><th>Qty</th><th>Financial</th><th>Fulfillment</th></tr></thead><tbody></tbody></table>
    </div>
  </article>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.__GROUP_KEY__ = "{{ group_key }}";
</script>
<script src="/static/js/config.js"></script>
<script src="/static/js/product_details.js"></script>
<script>
  // Add info tooltips on render by overriding placeholders after JS populates
  // product_details.js writes innerHTML for snapshot/velocity; we enrich labels with title="..."
  const addMetricTooltips = () => {
    const snap = document.getElementById('pd-snapshot');
    const vel = document.getElementById('pd-velocity');
    if (!snap || !vel) return;
    // Snapshot labels map
    const map = {
      'On Hand (deduped)': 'Minimum available across stores + committed across all stores (to avoid double counting).',
      'Committed': 'Units reserved on open/unfulfilled orders across all stores in this group.',
      'Available': 'On-hand minus committed (deduped across stores).',
      'Life on Shelf (days)': 'Days since first seen: earliest of product created, first order, or first inventory update.',
    };
    snap.querySelectorAll('.metric p').forEach(p => {
      const t = p.textContent?.trim();
      if (t && map[t]) p.innerHTML = `${t} <span title="${map[t]}" style="cursor:help;font-weight:bold;">i</span>`;
    });
    const vmap = {
      'Avg Daily (period)': 'Total units sold in selected period divided by number of days.',
      'Avg Monthly': 'Avg Daily ร 30.',
      'Velocity 7d': 'Average units/day sold over the last 7 days of the period.',
      'Velocity 30d': 'Average units/day sold over the last 30 days of the period.',
      'Velocity 90d': 'Average units/day sold over the last 90 days of the period.',
      'Days of Cover (30d)': 'Available รท Velocity 30d. Estimated days until stock-out.',
    };
    vel.querySelectorAll('.metric p').forEach(p => {
      const t = p.textContent?.trim();
      if (t && vmap[t]) p.innerHTML = `${t} <span title="${vmap[t]}" style="cursor:help;font-weight:bold;">i</span>`;
    });
  };
  // when the page fetch completes and fills content, we hook into a small delay
  document.addEventListener('inventory:product_details_rendered', addMetricTooltips);
  // Also try once after load (in case content is already there)
  window.addEventListener('load', () => setTimeout(addMetricTooltips, 500));
</script>
{% endblock %}
