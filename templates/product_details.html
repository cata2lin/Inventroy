{% extends "base.html" %}
{% block content %}
<div class="container">
<hgroup class="page-header">
<h1 id="pd-title">Product Details</h1>
<h2 id="pd-subtitle"></h2>
</hgroup>


<article class="controls-grid sticky-controls">
<div>
<label>Period start</label>
<input type="date" id="pd-start">
</div>
<div>
<label>Period end</label>
<input type="date" id="pd-end">
</div>
<div>
<label>Store</label>
<select id="pd-store"><option value="">All Stores</option></select>
</div>
<div class="grid" style="gap:.5rem;align-items:end;">
<button id="pd-apply" class="secondary">Apply</button>
<button id="pd-7" class="outline">7d</button>
<button id="pd-30" class="outline">30d</button>
<button id="pd-90" class="outline">90d</button>
</div>
</article>


<article class="grid cards-grid">
<div class="card">
<header><strong>Snapshot</strong></header>
<div id="pd-snapshot" class="grid metrics-grid"></div>
</div>
<div class="card">
<header><strong>Sales Velocity</strong></header>
<div id="pd-velocity" class="grid metrics-grid"></div>
</div>
</article>


<article class="card">
    <header><strong>Stock Evolution</strong></header>
    <div class="chart-wrap">
        <canvas id="pd-stock-canvas"></canvas>
    </div>
</article>


<article class="grid cards-grid">
<div class="card">
<header><strong>Stock Movements (by day)</strong></header>
<div class="overflow-auto" style="max-height:300px">
<table id="pd-sm-table" class="data-table"><thead><tr><th>Date</th><th>Change</th></tr></thead><tbody></tbody></table>
</div>
</div>
<div class="card">
<header><strong>Committed Orders</strong></header>
<div class="overflow-auto" style="max-height:300px">
<table id="pd-committed" class="data-table"><thead><tr><th>Date</th><th>Order</th><th>Qty</th><th>Status</th></tr></thead><tbody></tbody></table>
</div>
</div>
</article>


<article class="card">
<header><strong>Recent Orders (last 200)</strong></header>
<div class="overflow-auto" style="max-height:360px">
<table id="pd-orders" class="data-table"><thead><tr><th>Date</th><th>Order</th><th>Qty</th><th>Financial</th><th>Fulfillment</th></tr></thead><tbody></tbody></table>
</div>
</article>
</div>
{% endblock %}


{% block scripts %}
<script>
window.__GROUP_KEY__ = "{{ group_key }}";
</script>
<script src="/static/js/config.js"></script>
<script src="/static/js/product_details.js"></script>
<script>
// Tooltip enrichment on render (kept, with improved selector stability)
const addMetricTooltips = () => {
const snap = document.getElementById('pd-snapshot');
const vel = document.getElementById('pd-velocity');
if (!snap || !vel) return;


const map = {
'On Hand (deduped)': 'Minimum available across stores + committed across all stores (to avoid double counting).',
'Committed': 'Units reserved on open/unfulfilled orders across all stores in this group.',
'Available': 'On-hand minus committed (deduped across stores).',
'Life on Shelf (days)': 'Days since first seen: earliest of product created, first order, or first inventory update.',
};
snap.querySelectorAll('.metric p').forEach(p => {
const t = p.textContent?.trim();
if (t && map[t]) p.innerHTML = `${t} <span title="${map[t]}" class="hint">i</span>`;
});


const vmap = {
'Avg Daily (period)': 'Total units sold in selected period divided by number of days.',
'Velocity 7d': 'Average units/day sold over the last 7 days of the period.',
'Velocity 30d': 'Average units/day sold over the last 30 days of the period.',
};
vel.querySelectorAll('.metric p').forEach(p => {
const t = p.textContent?.trim();
if (t && vmap[t]) p.innerHTML = `${t} <span title="${vmap[t]}" class="hint">i</span>`;
});
};


document.addEventListener('inventory:product_details_rendered', addMetricTooltips);
window.addEventListener('load', () => setTimeout(addMetricTooltips, 500));
</script>
{% endblock %}