{% extends "base.html" %}
{% block content %}
<h1 id="pd-title">Product Details</h1>
<h2 id="pd-subtitle"></h2>

<section class="grid compact-filter">
  <div>
    <label for="pd-start">Period start</label>
    <input type="date" id="pd-start" name="start-date" />
  </div>
  <div>
    <label for="pd-end">Period end</label>
    <input type="date" id="pd-end" name="end-date" />
  </div>
  <div>
    <label for="pd-store">Store</label>
    <select id="pd-store"><option value="">All Stores</option></select>
  </div>
  <fieldset>
    <legend class="visually-hidden">Quick Range</legend>
    <button id="pd-apply" class="secondary">Apply</button>
    <button id="pd-7" class="outline">7d</button>
    <button id="pd-30" class="outline">30d</button>
    <button id="pd-90" class="outline">90d</button>
  </fieldset>
</section>

<div class="grid">
  <div class="card">
    <h3>Snapshot</h3>
    <div id="pd-snapshot" class="grid" aria-live="polite"></div>
  </div>
  <div class="card">
    <h3>Sales Velocity</h3>
    <div id="pd-velocity" class="grid" aria-live="polite"></div>
  </div>
</div>

<div class="card">
  <h3>Sales by Day</h3>
  <canvas id="pd-sales-canvas" height="220" role="img" aria-label="Daily sales chart">Your browser does not support canvas.</canvas>
</div>

<div class="grid">
  <div class="card">
    <h3>Stock Movements (by day)</h3>
    <div class="overflow-auto" style="max-height: 300px;">
      <table id="pd-sm-table">
        <thead>
          <tr><th scope="col">Date</th><th scope="col">Change</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3>Committed Orders</h3>
    <div class="overflow-auto" style="max-height: 300px;">
      <table id="pd-committed">
        <thead>
          <tr><th scope="col">Date</th><th scope="col">Order</th><th scope="col">Qty</th><th scope="col">Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="card">
  <h3>Recent Orders (last 200)</h3>
  <div class="overflow-auto" style="max-height: 360px;">
    <table id="pd-orders">
      <thead>
        <tr>
          <th scope="col">Date</th><th scope="col">Order</th><th scope="col">Qty</th><th scope="col">Financial</th><th scope="col">Fulfillment</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  window.__GROUP_KEY__ = "{{ group_key }}";
</script>
<script src="/static/js/config.js"></script>
<script src="/static/js/product_details.js"></script>
<script>
  const addMetricTooltips = () => {
    const snap = document.getElementById('pd-snapshot');
    const vel = document.getElementById('pd-velocity');
    if (!snap || !vel) return;
    const map = {
      'On Hand (deduped)': 'Minimum available across stores + committed across all stores.',
      'Committed': 'Units reserved on open/unfulfilled orders across all stores.',
      'Available': 'On-hand minus committed.',
      'Life on Shelf (days)': 'Days since first seen: earliest of product creation, order, or inventory update.',
    };
    snap.querySelectorAll('.metric p').forEach(p => {
      const t = p.textContent?.trim();
      if (t && map[t]) p.innerHTML = `${t} <span title="${map[t]}" style="cursor:help;font-weight:bold;">i</span>`;
    });
    const vmap = {
      'Avg Daily (period)': 'Total sold รท days in period.',
      'Avg Monthly': 'Average daily ร 30.',
      'Velocity 7d': 'Avg units/day over last 7 days.',
      'Velocity 30d': 'Avg units/day over last 30 days.',
      'Velocity 90d': 'Avg units/day over last 90 days.',
      'Days of Cover (30d)': 'Available รท Velocity 30d.',
    };
    vel.querySelectorAll('.metric p').forEach(p => {
      const t = p.textContent?.trim();
      if (t && vmap[t]) p.innerHTML = `${t} <span title="${vmap[t]}" style="cursor:help;font-weight:bold;">i</span>`;
    });
  };
  document.addEventListener('inventory:product_details_rendered', addMetricTooltips);
  window.addEventListener('load', () => setTimeout(addMetricTooltips, 500));
</script>
{% endblock %}
