<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }} - Inventory Intelligence</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
<link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
<a class="skip-link" href="#main-content">Skip to content</a>

<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
<symbol id="i-search" viewBox="0 0 24 24">
<path d="M10 18a8 8 0 1 1 5.292-14.043l.22.184.276.23a8 8 0 0 1 1.26 10.532l4.21 4.21-1.414 1.414-4.21-4.21A8 8 0 0 1 10 18Zm0-2a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/>
</symbol>
<symbol id="i-refresh" viewBox="0 0 24 24">
<path d="M12 6V3L8 7l4 4V8c2.761 0 5 2.239 5 5a5 5 0 0 1-9.33 2.5l-1.74 1c1.37 2.39 3.96 4 7.07 4 4.42 0 8-3.58 8-8s-3.58-8-8-8z"/>
</symbol>
<symbol id="i-download" viewBox="0 0 24 24">
<path d="M5 20h14v-2H5v2Zm7-18v10.17l3.59-3.58L17 10l-5 5-5-5 1.41-1.41L11 12.17V2h1Z"/>
</symbol>
<symbol id="i-filter" viewBox="0 0 24 24">
<path d="M10 18h4v-2h-4v2Zm-7-12v2h18V6H3Zm3 7h12v-2H6v2Z"/>
</symbol>
<symbol id="i-columns" viewBox="0 0 24 24">
<path d="M4 4h7v16H4V4Zm9 0h7v16h-7V4Z"/>
</symbol>
<symbol id="i-left" viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
<symbol id="i-right" viewBox="0 0 24 24"><path d="m10 17 5-5-5-5-1.41 1.41L12.17 12l-3.58 3.59z"/></symbol>
<symbol id="i-close" viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.41L10.59 13.41 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.3l6.3 6.29 6.29-6.29z"/></symbol>
</svg>

<div class="app-layout">
<aside class="sidebar" aria-label="Primary">
<div class="brand">
<strong>Inventory&nbsp;Intelligence</strong>
</div>
<nav>
<ul>
<li><a href="/dashboard-v2" {% if title == "Dashboard" %}class="contrast active"{% endif %}>Dashboard</a></li>
<li><a href="/inventory" {% if title == "Inventory Report" %}class="contrast active"{% endif %}>Inventory Report</a></li>
<li><a href="/forecasting" {% if title == "Forecasting" %}class="contrast active"{% endif %}>Forecasting</a></li>
<li><a href="/bulk-update" {% if title == "Bulk Update" %}class="contrast active"{% endif %}>Bulk Update</a></li>
<li><a href="/sync-control" {% if title == "Sync Control" %}class="contrast active"{% endif %}>Sync Control</a></li>
<li><a href="/config" {% if title == "Configuration" %}class="contrast active"{% endif %}>Configuration</a></li>
</ul>
</nav>
</aside>

<main id="main-content" class="main-content">
{% block content %}{% endblock %}
</main>
</div>

<!-- Fixed THEAD script -->
<script>
(() => {
  const SELECT_TABLES = [
    '#orders-table-container table',
    '#inventory-table-container table',
    '#forecasting-table-container table',
    '#bulk-update-container table'
  ].join(',');

  const stickyBars = () => Array.from(document.querySelectorAll('.sticky-controls'));

  function computeTopOffset() {
    let offset = 0;
    for (const el of stickyBars()) {
      const r = el.getBoundingClientRect();
      if (r.top <= 0 && r.bottom > offset) offset = Math.ceil(r.bottom);
    }
    return offset;
  }

  function makeStickyHeader(table) {
    if (!table || table.__stickyClone) return;
    const thead = table.querySelector('thead');
    if (!thead) return;

    const host = document.createElement('div');
    host.className = 'sticky-thead';
    const cloneTable = document.createElement('table');
    const cloneThead = thead.cloneNode(true);
    cloneTable.appendChild(cloneThead);
    host.appendChild(cloneTable);
    document.body.appendChild(host);

    table.__stickyClone = { host, cloneTable, cloneThead, thead };

    const syncWidths = () => {
      const { thead, cloneThead } = table.__stickyClone;
      const origRows = thead.querySelectorAll('tr');
      const cloneRows = cloneThead.querySelectorAll('tr');
      if (!origRows.length || origRows.length !== cloneRows.length) return;

      cloneTable.className = table.className;

      for (let r = 0; r < origRows.length; r++) {
        const oCells = origRows[r].children;
        const cCells = cloneRows[r].children;
        for (let i = 0; i < oCells.length; i++) {
          const w = Math.ceil(oCells[i].getBoundingClientRect().width);
          cCells[i].style.minWidth = w + 'px';
          cCells[i].style.maxWidth = w + 'px';
          cCells[i].style.width = w + 'px';
        }
      }

      const tb = table.getBoundingClientRect();
      cloneTable.style.width = Math.ceil(tb.width) + 'px';
      host.style.transform = `translateX(${Math.floor(tb.left)}px)`;
    };

    const syncTopAndVisibility = () => {
      const rect = table.getBoundingClientRect();
      const theadRect = thead.getBoundingClientRect();
      const topOffset = computeTopOffset();

      host.style.top = topOffset + 'px';

      const passedTop = theadRect.top <= topOffset;
      const stillInView = rect.bottom > (topOffset + Math.max(0, theadRect.height));

      host.style.display = (passedTop && stillInView) ? 'block' : 'none';
    };

    const fullSync = () => { syncWidths(); syncTopAndVisibility(); };

    const resizeObs = new ResizeObserver(fullSync);
    resizeObs.observe(table);
    Array.from(thead.querySelectorAll('*')).forEach(el => resizeObs.observe(el));

    window.addEventListener('scroll', fullSync, { passive: true });
    window.addEventListener('resize', fullSync);

    setTimeout(fullSync, 0);
    setTimeout(fullSync, 100);
    setTimeout(fullSync, 300);
  }

  const attachToExisting = () => {
    document.querySelectorAll(SELECT_TABLES).forEach(makeStickyHeader);
  };

  const mo = new MutationObserver(() => attachToExisting());
  mo.observe(document.documentElement, { childList: true, subtree: true });

  attachToExisting();
})();
</script>

{% block scripts %}{% endblock %}
</body>
</html>
