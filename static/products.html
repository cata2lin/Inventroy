<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - Inventory Intelligence</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        body { padding-bottom: 5rem; }
        .overflow-auto { max-height: 70vh; }
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 1rem 2rem; border-radius: 0.5rem; background-color: #384955;
            color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        #toast.show { opacity: 1; visibility: visible; }
        #toast.error { background-color: #d32f2f; }
        #toast.success { background-color: #388e3c; }
        td .field-group { display: flex; align-items: center; gap: 0.5rem; }
        td input { margin-bottom: 0; min-width: 100px; }
        td button { margin: 0; padding: 0.3rem 0.6rem; line-height: 1; min-width: auto; }
        .status-active { color: #388e3c; }
        .status-draft { color: #f57c00; }
        .status-archived { color: #546e7a; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>Inventory Intelligence</strong></li>
            </ul>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/products" role="button" class="contrast">Products</a></li>
<li><a href="/inventory">Grouped Inventory</a></li>
            </ul>
        </nav>

        <hgroup>
            <h1>Product Management</h1>
            <h2>Update product variant details and push changes to Shopify.</h2>
        </hgroup>

        <article>
            <header>Store & Actions</header>
            <div class="grid">
                <div>
                    <label for="storeSelector">Select a Store</label>
                    <select id="storeSelector" required>
                        <option value="">Loading stores...</option>
                    </select>
                </div>
                <div>
                    <label for="syncProductsButton">Inventory Sync</label>
                    <button id="syncProductsButton" disabled>Sync Inventory</button>
                </div>
            </div>
        </article>

        <article id="product-table-container" style="display: none;">
            <header>Product Variants</header>
            <div id="variants-content" class="overflow-auto">
                <p>Select a store to view its product variants.</p>
            </div>
        </article>
    </main>
    
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const storeSelector = document.getElementById('storeSelector');
            const syncProductsButton = document.getElementById('syncProductsButton');
            const variantsContent = document.getElementById('variants-content');
            const productTableContainer = document.getElementById('product-table-container');
            const toast = document.getElementById('toast');
            let currentStoreId = null;

            const showToast = (message, type = 'info', duration = 4000) => {
                toast.textContent = message;
                toast.className = `show ${type}`;
                setTimeout(() => { toast.className = ''; }, duration);
            };

            const loadStores = async () => {
                try {
                    const response = await fetch('/api/dashboard/stores');
                    if (!response.ok) throw new Error('Failed to load stores.');
                    const stores = await response.json();
                    storeSelector.innerHTML = '<option value="" disabled selected>Select a store</option>';
                    stores.forEach(store => storeSelector.add(new Option(store.name, store.id)));
                } catch (error) {
                    storeSelector.innerHTML = '<option value="">Could not load stores</option>';
                }
            };

            const loadVariants = async () => {
                if (!currentStoreId) return;
                productTableContainer.style.display = 'block';
                variantsContent.innerHTML = '<p><progress></progress><br>Loading variants...</p>';
                try {
                    // CORRECTED API PATH
                    const response = await fetch(`/api/inventory/variants/${currentStoreId}`);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || 'Failed to load variants.');
                    }
                    renderVariantsTable(await response.json());
                } catch (error) {
                    variantsContent.innerHTML = `<p>Error loading variants: ${error.message}</p>`;
                }
            };

            const renderVariantsTable = (variants) => {
                if (!variants || variants.length === 0) {
                    variantsContent.innerHTML = '<p>No product variants found for this store.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Product (Status)</th><th>Variant Title</th><th>SKU</th><th>Barcode</th>
                            <th>Price</th><th>Compare At</th><th>Cost</th><th>Available Qty</th><th>On Hand Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${variants.map(v => `
                            <tr data-variant-id="${v.id}">
                                <td>
                                    ${v.product_title}<br>
                                    <small class="status-${(v.product_status || 'unknown').toLowerCase()}">${v.product_status}</small>
                                </td>
                                ${createEditableCell(v, 'title', 'text')}
                                ${createEditableCell(v, 'sku', 'text')}
                                ${createEditableCell(v, 'barcode', 'text')}
                                ${createEditableCell(v, 'price', 'text')}
                                ${createEditableCell(v, 'compareAtPrice', 'text')}
                                ${createEditableCell(v, 'cost', 'text')}
                                ${createEditableCell(v, 'available', 'number', v.inventory_management !== 'shopify', v.available_quantity)}
                                ${createEditableCell(v, 'onHand', 'number', v.inventory_management !== 'shopify', v.on_hand_quantity)}
                            </tr>
                        `).join('')}
                    </tbody>`;
                variantsContent.innerHTML = '';
                variantsContent.appendChild(table);
            };

            const createEditableCell = (variant, fieldName, inputType, disabled = false, value = null) => {
                let fieldValue = value;
                if (fieldValue === null || fieldValue === undefined) {
                    fieldValue = variant[fieldName] || '';
                }
                const placeholder = fieldName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                return `
                    <td>
                        <div class="field-group">
                            <input name="${fieldName}" type="${inputType}" value="${fieldValue}" placeholder="${placeholder}" ${disabled ? 'disabled' : ''}>
                            <button class="secondary outline" 
                                    onclick="updateField(this, '${fieldName}')" 
                                    ${disabled ? 'disabled' : ''}>âœ“</button>
                        </div>
                    </td>`;
            };

            window.updateField = async (button, field) => {
                const row = button.closest('tr');
                const variantId = row.dataset.variantId;
                const input = row.querySelector(`input[name="${field}"]`);
                const value = input.value;

                const payload = {
                    variant_id: parseInt(variantId, 10),
                    field: field,
                    value: input.type === 'number' ? (value === '' ? null : parseInt(value, 10)) : value
                };
                
                button.setAttribute('aria-busy', 'true');
                button.disabled = true;
                input.disabled = true;

                try {
                    // CORRECTED API PATH
                    const response = await fetch(`/api/inventory/variants/update-field/${currentStoreId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Update failed.');
                    showToast(result.message || 'Update successful!', 'success');
                    
                    if(field === 'available' || field === 'onHand' || field === 'cost') {
                       await loadVariants();
                    }

                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    button.removeAttribute('aria-busy');
                    button.disabled = false;
                    input.disabled = false;
                }
            };

            storeSelector.addEventListener('change', () => {
                currentStoreId = storeSelector.value;
                syncProductsButton.disabled = !currentStoreId;
                loadVariants();
            });

            syncProductsButton.addEventListener('click', async () => {
                if (!currentStoreId) return;
                syncProductsButton.setAttribute('aria-busy', 'true');
                syncProductsButton.disabled = true;
                showToast(`Starting inventory sync for store ID ${currentStoreId}...`);

                try {
                    // CORRECTED API PATH
                    const response = await fetch(`/api/inventory/sync/${currentStoreId}`, { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Sync request failed.');
                    showToast(result.message);
                    
                    await loadVariants();
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    syncProductsButton.removeAttribute('aria-busy');
                    syncProductsButton.disabled = false;
                }
            });

            loadStores();
        });
    </script>
</body>
</html>